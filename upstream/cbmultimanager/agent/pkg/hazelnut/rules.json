[
  {
    "ruleName": "memcachedCrash",
    "file": "memcached.log",
    "contains": "Breakpad caught crash",
    "hints": {
      "level": "warning"
    },
    "result": {
      "name": "memcachedCrash",
      "status": "alert",
      "remediation": "The Data Service crashed. Examine its logs or contact Couchbase Technical Support.",
      "id": "CB90036"
    },
    "testCases": [
      {
        "name": "match",
        "input": {
          "level": "warning",
          "file": "memcached.log",
          "message": "Breakpad caught crash in memcached. Writing crash dump to /opt/couchbase/var/lib/couchbase/crash/1e4a92b9-e350-b8d2-67b966ba-1b89a355.dmp before terminating."
        },
        "expected": {
          "name": "memcachedCrash",
          "status": "alert",
          "requireRemediation": true
        }
      },
      {
        "name": "noMatch",
        "input": {
          "level": "info",
          "file": "memcached.log",
          "message": "Breakpad enabled. Minidumps will be written to '/opt/couchbase/var/lib/couchbase/crash'"
        },
        "expected": null
      }
    ]
  },

  {
    "ruleName": "managedProcessCrash",
    "file": "babysitter.log",
    "hints": {
      "level": "info"
    },
    "contains": "Cushion managed supervisor",
    "regexp": ".*Cushion managed supervisor for (.+) failed:.*",
    "result": {
      "status": "alert",
      "remediation": "The $1 process exited abnormally. Examine its logs or contact Couchbase Technical Support.",
      "name": "cushionManagedFail"
    },
    "testCases": [
      {
        "name": "match",
        "input": {
          "level": "info",
          "file": "babysitter.log",
          "message": "[ns_server:info,2022-01-18T16:21:13.015Z,babysitter_of_ns_1@cb.local:<0.21473.0>:supervisor_cushion:handle_info:60]Cushion managed supervisor for eventing failed:  {abnormal,2}"
        },
        "expected": {
          "name": "cushionManagedFail",
          "status": "alert",
          "remediation": "The eventing process exited abnormally. Examine its logs or contact Couchbase Technical Support.",
          "requireRemediation": true
        }
      }
    ]
  },

  {
    "ruleName": "oomKill",
    "file": "dmesg",
    "contains": "invoked oom-killer",
    "regexp": "(.+) invoked oom-killer:",
    "result": {
      "status": "warn",
      "remediation": "The $1 process was killed by the OOM Killer. Ensure this node has sufficient RAM.",
      "name": "oomKills"
    },
    "testCases": [
      {
        "name": "match",
        "input": {
          "file": "dmesg",
          "message": "perl invoked oom-killer: gfp_mask=0x280da, order=0, oom_score_adj=-1000"
        },
        "expected": {
          "name": "oomKills",
          "status": "warn",
          "requireRemediation": true,
          "remediation": "The perl process was killed by the OOM Killer. Ensure this node has sufficient RAM."
        }
      }
    ]
  },

  {
    "ruleName": "synFlooding",
    "file": "dmesg",
    "contains": "Possible SYN flooding on port",
    "regexp": "Possible SYN flooding on port (.+). Sending cookies.",
    "result": {
      "name": "synFlooding",
      "status": "warn",
      "remediation": "Buffer used for storing incoming SYN packets is full, reduce the number of incoming connections to port $1",
      "id": "CB90074"
    },
    "testCases": [
      {
        "name": "match",
        "input": {
          "file": "dmesg",
          "message": "TCP: request_sock_TCP: Possible SYN flooding on port 8093. Sending cookies.  Check SNMP counters."
        },
        "expected": {
          "name": "synFlooding",
          "status": "warn",
          "requireRemediation": true,
          "remediation": "Buffer used for storing incoming SYN packets is full, reduce the number of incoming connections to port 8093"
        }
      }
    ]
  },

  {
    "ruleName": "segfault",
    "file": "dmesg",
    "regexp": "(segfault|trap int3|general protection)",
    "result": {
      "status": "warn",
      "remediation": "Segmentation faults seen in the system logs. Check overall system and application health.",
      "name": "segfaults"
    },
    "testCases": [
      {
        "name": "match",
        "input": {
          "file": "dmesg",
          "message": "a.out[6504]: segfault at 0 ip 00000000004004f9 sp 00007fff71770150 error 6 in a.out[400000+1000]",
          "priority": 6,
          "sec": 483,
          "sequence": 448,
          "usec": 448066
        },
        "expected": {
          "name": "segfaults",
          "status": "warn",
          "requireRemediation": true
        }
      }
    ]
  },
  
  {
    "ruleName": "cpuSoftLockup",
    "file": "dmesg",
    "contains": "soft lockup",
    "result": {
      "status": "warn",
      "remediation": "If deploying Couchbase Server in a Virtual Environment check if said enviroment is overcommitted.",
      "name": "cpuSoftLockup"
    },
    "testCases": [
      {
        "name": "match",
        "input": {
          "file": "dmesg",
          "message": "kernel:NMI watchdog: BUG: soft lockup - CPU#5 stuck for 22s! [projector:19124]"
        },
        "expected": {
          "name": "cpuSoftLockup",
          "status": "warn",
          "requireRemediation": true
        }
      }
    ]
  },

  {
    "ruleName": "rejectedConnections",
    "file": "memcached.log",
    "contains": "Shutting down client as we're running out of connections",
    "hints": {
      "level": "warn"
    },
    "result": {
      "name": "kvConnectionLimit",
      "status": "alert",
      "remediation": "Client connections have been rejected because the connection limit has been exceeded. Ensure your applications are properly closing opened connections. Review the documentation for the Couchbase SDKs in use for details."
    },
    "testCases": [
      {
        "name": "match",
        "input": {
          "level": "warn",
          "file": "memcached.log",
          "message": "Shutting down client as we're running out of connections: 21 of 20"
        },
        "expected":  {
          "name": "kvConnectionLimit",
          "status": "alert",
          "requireRemediation": true
        }
      }
    ]
  },

  {
    "ruleName": "conntrackFull",
    "file": "dmesg",
    "contains": "nf_conntrack: table full, dropping packet",
    "result": {
      "status": "alert",
      "remediation": "The connection tracking table is full, this can lead to packets being dropped and client timeouts. Please reduce the number of connections to this node.",
      "name": "conntrackFull"
    },
    "testCases": [
      {
        "name": "match",
        "input": {
          "file": "dmesg",
          "message": "kernel: [1564292.095866] nf_conntrack: table full, dropping packet."
        },
        "expected": {
          "name": "conntrackFull",
          "status": "alert",
          "requireRemediation": true
        }
      }
    ]
  },

  {
    "ruleName": "possibleSharedStorage",
    "file": "dmesg",
    "regexp": ".*(Fibre Channel|iqn.|iSCSI).*",
    "result": {
      "status": "warn",
      "remediation": "Ensure each node has an independent storage layer to remove a single point of failure.",
      "name": "possibleSharedStorage"
    },
    "testCases": [
      {
        "name": "match",
        "input": {
          "file": "dmesg",
          "message": "[Tue May 18 17:43:16 2021] Loading iSCSI transport class v2.0-870."
        },
        "expected": {
          "name": "possibleSharedStorage",
          "status": "warn",
          "requireRemediation": true
        }
      }
    ]
  },

  {
    "ruleName": "documentTooBig",
    "file": "projector.log",
    "contains": "doReceive",
    "regexp": ".* (.+) is too big.*",
    "result": {
      "status": "warn",
      "remediation": "Document size has exceeded 20MB($1 B). Please reduce document size. Check projector log for more detail.",
      "name": "documentTooBig",
      "id": "CB90086"
    },
    "testCases": [
      {
        "name": "match",
        "input": {
          "file": "projector.log",
          "message": "[Error] DCPT[secidx:proj-sxoprd_posentities-MAINT_STREAM_TOPIC_ea678d87a86f96705627397d634ec781-1339850182609080814/1] doReceive(): 20976104 is too big (max 20971520)"
        },
        "expected": {
          "name": "documentTooBig",
          "status": "warn",
          "remediation": "Document size has exceeded 20MB(20976104 B). Please reduce document size. Check projector log for more detail.",
          "requireRemediation": true
        }
      },
      {
        "name": "noerror",
        "input": {
          "file": "projector.log",
          "message": "[Info] DCPT[secidx:proj-sxoprd_posentities-MAINT_STREAM_TOPIC_ea678d87a86f96705627397d634ec781-1339850182609080814/1] ##45fe ... stopped"
        },
        "expected": null
      }
    ]
  },
  {
    "ruleName": "highPrometheusLoadTime",
    "file": "prometheus.log",
    "contains": "Completed loading of configuration file",
    "customFields":[
        {
        "name": "totalDuration",
        "type": "time",
        "timeThreshold": "1s"
        }
        ],
    "result": {
      "name": "highPrometheusLoadTime",
      "status": "warning",
      "remediation": "More than 1s load time noticed for Prometheus configuration file. Lack of reverse DNS resolution can lead to high configuration load time",
      "id": "CB90085"
    },
    "testCases": [
        {
            "name": "match",
            "input": {
              "level": "info",
              "file": "prometheus.log",
              "message": "Completed loading of configuration file",
              "totalDuration" : "2s"
            },
            "expected": {
              "name": "highPrometheusLoadTime",
              "status": "warning",
              "requireRemediation": true,
              "remediation": "More than 1s load time noticed for Prometheus configuration file. Lack of reverse DNS resolution can lead to high configuration load time"
            }
          },
          {
            "name": "noerror",
            "input": {
              "level": "info",
              "file": "prometheus.log",
              "message": "Completed loading of configuration file",
              "totalDuration" : "2ms"
            },
            "expected": null
          }
    ]
  },
  {
    "ruleName": "xdcrInvalidDatatypeCheck",
    "file": "goxdcr.log",
    "contains": "Invalid datatype provided",
    "customFields":[
      {
        "name": "status",
        "type": "string",
        "regexp": "EINVAL"
      }
    ],
    "result": {
      "status": "warning",
      "remediation": "RBAC user is incorrectly configured. Check for SET_WITH_META errors in logs to confirm. See documentation for remediation.",
      "name": "xdcrInvalidDatatypeCheck",
      "id": "CB90089"
    },
    "testCases": [
      {
        "name": "match",
        "input": {
          "file": "goxdcr.log",
          "message": "error\":{\"context\":\"Invalid datatype provided\"}",
          "status": "EINVAL"
        },
        "expected": {
          "name": "xdcrInvalidDatatypeCheck",
          "status": "warning",
          "remediation": "RBAC user is incorrectly configured. Check for SET_WITH_META errors in logs to confirm. See documentation for remediation.",
          "requireRemediation": true
        }
      },
      {
        "name": "noerror",
        "input": {
          "file": "goxdcr.log",
          "message": "2021-03-19T22:47:00.135177+08:00 WARNING 72 [ 10.192.72.171:40316 - 10.204.72.23:11210 (<ud>cb_xdcr</ud>) ]: no access to command SET_WITH_META"
        },
        "expected": null
      }
    ]
  }
]
