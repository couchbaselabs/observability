<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Couchbase Monitoring and Observability Stack :: Couchbase Monitoring and Observability Stack</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/cmos">Couchbase Monitoring and Observability Stack</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="cmos" data-version="0.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Couchbase Monitoring and Observability Stack</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="index.html">Welcome</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="http://localhost:8080/promwebform.html">Prometheus Add Endpoint</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="http://localhost:8080/prometheus/alerts/">Prometheus Alerts</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="http://localhost:8080/prometheus/rules/">Prometheus Rules</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="http://localhost:8080/prometheus/targets/">Prometheus Targets</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tooling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="http://localhost:8080/alertmanager/">Alert Manager</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="http://localhost:8080/couchbase/ui/">Couchbase Cluster Monitor</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="http://localhost:8080/grafana/">Grafana</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="http://localhost:8080/prometheus/">Prometheus</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Couchbase Monitoring and Observability Stack</span>
    <span class="version">0.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">Couchbase Monitoring and Observability Stack</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link is-current"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Couchbase Monitoring and Observability Stack</a></li>
    <li><a href="index.html">Welcome</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/couchbaselabs/observability/edit/main/docs/modules/ROOT/pages/index.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Couchbase Monitoring and Observability Stack</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The intention of this repository is to provide a simple, out-of-the-box solution based on industry standard tooling to observe the state of your Couchbase cluster.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An additional requirement is to ensure we can integrate into existing observability pipelines people may already have as easily as possible.</p>
</li>
<li>
<p>This must all support being deployed on-premise and on cloud platforms with minimal change.</p>
</li>
<li>
<p>Any bespoke software must be minimal and ideally just restricted to configuration of generic tools.</p>
</li>
<li>
<p>We must support customer configuration of what is "important" to monitor in their clusters although with best practice defaults provided.</p>
</li>
<li>
<p>A simple and often upgrade pipeline to support frequent changes and updates to the solution which are then easy to roll out for users.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We essentially need to support two fairly distinct types of user:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Those who have nothing and just want a simple working solution to monitor their cluster.</p>
</li>
<li>
<p>Those who have an existing monitoring pipeline and want to integrate Couchbase monitoring into it, likely with a set of custom rules and configuration.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quick_start"><a class="anchor" href="#_quick_start"></a>Quick Start</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure you have a Couchbase Server cluster running and accessible - for testing we recommend using <a href="https://github.com/couchbaselabs/vagrants">Vagrant</a> or <a href="https://docs.couchbase.com/cloud-native-database/containers/docker-basic-install.html">Docker</a></p>
</li>
<li>
<p>Ensure you have the <a href="https://github.com/couchbase/couchbase-exporter">Couchbase Prometheus Exporter</a> set up on each of your Couchbase Server nodes</p>
</li>
<li>
<p>Clone the couchbaselabs/observability repo: <code>git clone <a href="mailto:git@github.com">git@github.com</a>:couchbaselabs/observability.git</code></p>
</li>
<li>
<p>Part of CMOS is the proprietary Couchbase Cluster Monitor, in <a href="https://github.com/couchbaselabs/cbmultimanager">this private repository</a>. If you want to build CMOS to use it, <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#adding-your-ssh-key-to-the-ssh-agent">set up your local SSH agent</a>.</p>
</li>
<li>
<p>Build the container: <code>make container</code> if you want to include the Cluster Monitor or <code>make container-oss</code> otherwise</p>
</li>
<li>
<p>Run the microlith: <code>docker run --rm -d -p 8080:8080 --name cmos couchbase/observability-stack:v1</code> (if your Couchbase Server is running in Docker, you may need to set <a href="https://docs.docker.com/network/">extra options</a> to permit them to communicate.)</p>
</li>
<li>
<p>Browse to <a href="http://localhost:8080" class="bare">http://localhost:8080</a></p>
</li>
<li>
<p>Click "Prometheus Add Endpoint" and follow the instructions</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When you are done testing, run <code>docker stop cmos</code> to clean up.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_components"><a class="anchor" href="#_components"></a>Components</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This software uses the following components with their associated licensing also captured:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Grafana: AGPL 3.0 <a href="https://github.com/grafana/grafana/blob/main/LICENSE" class="bare">https://github.com/grafana/grafana/blob/main/LICENSE</a></p>
</li>
<li>
<p>Loki: AGPL 3.0 <a href="https://github.com/grafana/loki/blob/main/LICENSE" class="bare">https://github.com/grafana/loki/blob/main/LICENSE</a></p>
</li>
<li>
<p>Prometheus: Apache 2.0 <a href="https://github.com/prometheus/prometheus/blob/main/LICENSE" class="bare">https://github.com/prometheus/prometheus/blob/main/LICENSE</a></p>
</li>
<li>
<p>Alert Manager: Apache 2.0 <a href="https://github.com/prometheus/alertmanager/blob/master/LICENSE" class="bare">https://github.com/prometheus/alertmanager/blob/master/LICENSE</a></p>
</li>
<li>
<p>Fluent Bit: Apache 2.0 <a href="https://github.com/fluent/fluent-bit/blob/master/LICENSE" class="bare">https://github.com/fluent/fluent-bit/blob/master/LICENSE</a></p>
</li>
<li>
<p>Jaeger: Apache 2.0 <a href="https://github.com/jaegertracing/jaeger/blob/master/LICENSE" class="bare">https://github.com/jaegertracing/jaeger/blob/master/LICENSE</a></p>
</li>
<li>
<p>Nginx: <a href="https://github.com/nginxinc/docker-nginx/blob/master/LICENSE" class="bare">https://github.com/nginxinc/docker-nginx/blob/master/LICENSE</a></p>
</li>
<li>
<p>Prometheus Merge Tool: Apache 2.0 <a href="https://github.com/lablabs/prometheus-alert-overrider/blob/master/LICENSE" class="bare">https://github.com/lablabs/prometheus-alert-overrider/blob/master/LICENSE</a></p>
</li>
<li>
<p>Alpine.js: MIT <a href="https://github.com/alpinejs/alpine/blob/main/LICENSE.md" class="bare">https://github.com/alpinejs/alpine/blob/main/LICENSE.md</a></p>
</li>
<li>
<p>Couchbase Cluster Monitor: Proprietary to Couchbase <a href="https://github.com/couchbaselabs/cbmultimanager/blob/master/LICENSE" class="bare">https://github.com/couchbaselabs/cbmultimanager/blob/master/LICENSE</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nginx is used as the base image for the microlith container.</p>
</div>
<div class="paragraph">
<p>All licences are in the source repository and the microlith container in the <a href="microlith/licenses/"><code>/licenses</code></a> directory.</p>
</div>
<div class="paragraph">
<p>A statement is printed out to standard output/console at start up to indicate acceptance of licensing and where you can find them all.</p>
</div>
<div class="paragraph">
<p>A simple <a href="./tools/build-oss-container.sh">helper script</a> is provided as well to build without the Couchbase Cluster monitor.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_architecture"><a class="anchor" href="#_architecture"></a>Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Grafana-based stack has been selected for a few reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Already in use with Prometheus exporter and similar on Couchbase Server</p>
</li>
<li>
<p>Industry standard and OSS with various integration points for other pipelines</p>
</li>
<li>
<p>Existing options to scale from single node up to cloud scale easily</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We expose Prometheus endpoints already for node-level information on a Couchbase Server instance.
Recently we have exposed logs using Fluent Bit, primarily for kubernetes based solutions but this can be deployed on-premise as well.</p>
</div>
<div class="paragraph">
<p>There is also a project underway to provide cluster-level information via a Prometheus endpoint: <a href="https://github.com/couchbaselabs/cbmultimanager" class="bare">https://github.com/couchbaselabs/cbmultimanager</a>
This will essentially integrate Couchbase knowledge and best practices into a reusable component. We can then reuse this component in the monitoring stack here as it provides a Prometheus endpoint.</p>
</div>
<div class="paragraph">
<p>Our observability stack is therefore a combination of Couchbase-specific components that provide that discrete knowledge and monitoring of the Couchbase cluster which are then plumbed into a generic Grafana pipline like below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/healthcheck-blocks.png" alt="Overview">
</div>
</div>
<div class="paragraph">
<p>A complete working stack is provided with a Grafana UI to access it all.</p>
</div>
<div class="paragraph">
<p>We also provide the various Prometheus endpoints for people who want to plumb it into another stack, or federate Prometheus instances or some other alternative.
They can reuse all the configuration provided, just not use Grafana for example.</p>
</div>
<div class="paragraph">
<p>Configuration points are also provided to tune the various alerts, dashboards and other configuration for a particular deployment, although basic deployment will provide a configured best practice version that is fully usable.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_microlith_deployment"><a class="anchor" href="#_microlith_deployment"></a>Microlith deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To support easy deployment across a variety of targets, we are providing a 'microlith' single container option.
This is essentially the various scalable components of the Grafana stack (Loki, Prometheus, Grafana, Alert Manager) and Couchbase binaries for specific data extraction all runnable as a single multi-process container instance.</p>
</div>
<div class="paragraph">
<p>A single container can then be run on-premise or on a Kubernetes platform very easily with minimal effort.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/microlith-runtime.png" alt="Microlith overview">
</div>
</div>
<div class="paragraph">
<p>Whilst on-premise customers may primarily be using native binaries, all supported OS&#8217;s for Couchbase Server can run containers easily. This also makes it easier to deploy as a self-contained image and easy to upgrade as well. We could produce an OS-specific package (e.g. RPM) with all necessary dependencies on the container runtime.</p>
</div>
<div class="paragraph">
<p>For full details refer to the <a href="#microlith/README.adoc" class="page unresolved">microlith</a> sub-directory.</p>
</div>
<div class="sect2">
<h3 id="_on_premise_usage"><a class="anchor" href="#_on_premise_usage"></a>On-premise usage</h3>
<div class="paragraph">
<p>A working example is <a href="examples/native/">provided</a> based on a docker compose stack to run up a single node Couchbase cluster with the microlith all correctly configured.</p>
</div>
<div class="paragraph">
<p>The basic steps are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install a container runtime for your platform, for example on Ubuntu details are here: <a href="https://docs.docker.com/engine/install/ubuntu/" class="bare">https://docs.docker.com/engine/install/ubuntu/</a></p>
</li>
<li>
<p>Run the microlith container up: <code>docker run --name=couchbase-grafana --rm -d -P couchbase-observability</code></p>
</li>
<li>
<p>Configure the cluster to talk to it by providing credentials to Prometheus and cluster monitor tools.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Prometheus end points and credentials can be added to the <a href="microlith/dynamic/prometheus/couchbase/targets.json">config file</a> mounted into the container above. This is periodically rescanned and new end points added.</p>
</div>
<div class="paragraph">
<p>The cluster monitor currently requires configuration via a bespoke REST API:
<code>curl -u "${CLUSTER_MONITOR_USER}:${CLUSTER_MONITOR_PWD}" -X POST -d '{ "user": "'"${COUCHBASE_USER}"'", "password": "'"${COUCHBASE_PWD}"'", "host": "'"${COUCHBASE_ENDPOINT}"'" }' "${CLUSTER_MONITOR_ENDPOINT}/api/v1/clusters"</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>COUCHBASE_ENDPOINT should be set to a node that you want to monitor in a Couchbase cluster.</p>
</li>
<li>
<p>COUCHBASE_USER &amp; COUCHBASE_PWD are the credentials for accesing that cluster.</p>
</li>
<li>
<p>CLUSTER_MONITOR_ENDPOINT is the mapping to port 7196 of the container we started, e.g. <code>http://localhost:7196</code>. In the container run line above we map to dynamic ports so grab them using <code>docker container port couchbase-grafana 7196</code> and use that value in the URL.</p>
</li>
<li>
<p>CLUSTER_MONITOR_USER &amp; CLUSTER_MONITOR_PWD are the credentials for the cluster monitor tool, defaults to a <code>admin:password</code> but can be set differently using these variables when launching the container.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As an example to configure a new cluster node to be monitored:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CLUSTER_MONITOR_USER=admin
CLUSTER_MONITOR_PWD=password
CLUSTER_MONITOR_ENDPOINT=http://localhost:$(docker container port couchbase-grafana 7196)
COUCHBASE_USER=Administrator
COUCHBASE_PWD=password
COUCHBASE_ENDPOINT=http://db2:8091
curl -u "${CLUSTER_MONITOR_USER}:${CLUSTER_MONITOR_PWD}" -X POST -d '{ "user": "'"${COUCHBASE_USER}"'", "password": "'"${COUCHBASE_PWD}"'", "host": "'"${COUCHBASE_ENDPOINT}"'" }' "${CLUSTER_MONITOR_ENDPOINT}/api/v1/clusters"</pre>
</div>
</div>
<div class="paragraph">
<p>We can also run with a directory containing shell scripts that do the above: <code>-v $PWD/microlith/dynamic/healthcheck/:/etc/healthcheck/</code>
This will be re-scanned periodically and any scripts in it run.</p>
</div>
</div>
<div class="sect2">
<h3 id="_customization"><a class="anchor" href="#_customization"></a>Customization</h3>
<div class="paragraph">
<p>Areas to support customization:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dashboards</p>
<div class="ulist">
<ul>
<li>
<p>Support providing bespoke dashboards directly by specifying at runtime.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Alerting rules</p>
<div class="ulist">
<ul>
<li>
<p>Provide custom alert rules and other metric generation (e.g. pre-calculated ones)</p>
</li>
<li>
<p>Tweak the configuration for existing ones deployed</p>
</li>
<li>
<p>Disable or inhibit default rules provided</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cluster credentials and identities</p>
<div class="ulist">
<ul>
<li>
<p>Support adding new cluster nodes easily</p>
</li>
<li>
<p>Support fully dynamic credentials and discovery (no need to restart to pick up a change), e.g. <a href="https://github.com/mrsiano/openshift-grafana/blob/master/prometheus-high-performance.yaml#L292" class="bare">https://github.com/mrsiano/openshift-grafana/blob/master/prometheus-high-performance.yaml#L292</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In all cases we do not want to have to rebuild anything to customize it, it should just be a runtime configuration. This then supports a Git-ops style deployment with easy upgrade path as we always run the container plus config so you can modify each independently, roll back, etc.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/microlith-config.png" alt="Microlith configuration">
</div>
</div>
<div class="sect3">
<h4 id="_prometheus_alerting_rules"><a class="anchor" href="#_prometheus_alerting_rules"></a>Prometheus alerting rules</h4>
<div class="paragraph">
<p>There are three directories used for alerting rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/etc/prometheus/alerting/couchbase</code>: Couchbase preset rules. Do not modify these, as your changes may be overwritten when you upgrade. Instead, use overrides (described below).</p>
</li>
<li>
<p><code>/etc/prometheus/alerting/overrides</code>: Space for your overrides of the Couchbase rules. These will be pre-processed with <a href="https://github.com/lablabs/prometheus-alert-overrider">prometheus-alert-overrider</a>, enabling you to customize our rules. For an example, see <a href="https://github.com/couchbaselabs/observability/tree/main/testing/microlith-test/integration/prometheus_alert_overrides">our integration tests</a>.</p>
</li>
<li>
<p><code>/etc/prometheus/alerting/custom</code>: Space for your own custom rules. These will be loaded by Prometheus but will not be pre-processed in any way.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is also a fourth directory, <code>/etc/prometheus/alerting/generated</code>, where the processed rules file will be written. Do not modify this directory, as your changes may be overwritten as part of the build process.</p>
</div>
<div class="paragraph">
<p>If you want to disable the pre-processing and use entirely your own ruleset, set the environment variable <code>DISABLE_ALERTS_PREPARE=true</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cluster_monitor_checker_results"><a class="anchor" href="#_cluster_monitor_checker_results"></a>Cluster Monitor checker results</h4>
<div class="paragraph">
<p>If running with the Couchbase Cluster Monitor enabled, it will output the status of its checkers to Prometheus like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># HELP multimanager_cluster_checker_status Checker results for cluster level checkers
# TYPE multimanager_cluster_checker_status gauge
multimanager_cluster_checker_status{cluster="961b7464aca17a7db150fb0e44be5849",name="singleOrTwoNodeCluster"} 1
# HELP multimanager_node_checker_status Checker results for node level checkers
# TYPE multimanager_node_checker_status gauge
multimanager_node_checker_status{cluster="961b7464aca17a7db150fb0e44be5849",name="nonGABuild",node="47a45d39583947823ac9866dce2a74b2"} 0
multimanager_node_checker_status{cluster="961b7464aca17a7db150fb0e44be5849",name="oneServicePerNode",node="47a45d39583947823ac9866dce2a74b2"} 1
multimanager_node_checker_status{cluster="961b7464aca17a7db150fb0e44be5849",name="supportedVersion",node="47a45d39583947823ac9866dce2a74b2"} 0</pre>
</div>
</div>
<div class="paragraph">
<p>The values of each metric represent the current status of the checker. The integer values have the following meanings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0: Good (everything is fine, no action required)</p>
</li>
<li>
<p>1: Warn (potential issue, worth investigating)</p>
</li>
<li>
<p>2: Alert (serious issue, action required)</p>
</li>
<li>
<p>3: Info (informational only, no action required)</p>
</li>
<li>
<p>4: Missing (checker failed to run or information was not available)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_distributed_deployment"><a class="anchor" href="#_distributed_deployment"></a>Distributed deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TBD: <a href="https://github.com/couchbaselabs/observability/issues/6" class="bare">https://github.com/couchbaselabs/observability/issues/6</a></p>
</div>
<div class="paragraph">
<p>For those customers who want to scale up the deployment and/or follow a more cloud-native approach using microservices that are easier to manage.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing"><a class="anchor" href="#_testing"></a>Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We need to verify the following key use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Out of the box defaults provided for simple usage to give a cluster overview</p>
</li>
<li>
<p>Customization of rules and integrate into existing pipeline</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In two separate infrastructures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploying microlith to Kubernetes using CAO, automatic service discovery</p>
<div class="ulist">
<ul>
<li>
<p>Without CAO still possible but not tested</p>
</li>
<li>
<p>Can also mix-and-match this with on-premise cluster (COS in k8s, Couchbase Server on premise)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Deploying on-premise using manual configuration with the microlith</p>
<div class="ulist">
<ul>
<li>
<p>Remote end point or in Vagrant as well</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>We need to test the following aspects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Prometheus endpoint is available from the microlith</p>
</li>
<li>
<p>Adding the Couchbase Server instances to be monitored</p>
</li>
<li>
<p>Couchbase Server metrics are available (using the exporter pre 7.0) from the microlith endpoint</p>
<div class="ulist">
<ul>
<li>
<p>PromQL or promcli tooling can verify this</p>
</li>
</ul>
</div>
</li>
<li>
<p>Default alerting rules are triggered under appropriate failures</p>
<div class="ulist">
<ul>
<li>
<p>Defaults in general just work out of the box</p>
</li>
</ul>
</div>
</li>
<li>
<p>Custom alerting rules can be provided</p>
<div class="ulist">
<ul>
<li>
<p>Extend existing</p>
</li>
<li>
<p>Replace defaults</p>
</li>
</ul>
</div>
</li>
<li>
<p>Grafana dashboards are available from the microlith</p>
</li>
<li>
<p>Custom dashboards can be provided to the microlith</p>
<div class="ulist">
<ul>
<li>
<p>We can query the REST API for this information, i.e. what rules are present and firing, etc.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Loki endpoint is available from the microlith</p>
<div class="ulist">
<ul>
<li>
<p>LogQL can verify this and that there is some data (need to ensure we send some logs)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Components within the microlith can be enabled or disabled</p>
<div class="ulist">
<ul>
<li>
<p>Repeat one of the previous tests (e.g. Loki) with the component disabled and confirm the test fails.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Reproducible ephemeral container with custom configuration via GitOps</p>
<div class="ulist">
<ul>
<li>
<p>Configuration of cluster connection &amp; credentials</p>
</li>
<li>
<p>Addition of custom alerts and tuning/inhibition of those alerts, plus addition of custom dashboards</p>
</li>
</ul>
</div>
</li>
<li>
<p>Integration with an existing stack</p>
<div class="ulist">
<ul>
<li>
<p>Use Grafana operator here to create a separate stack in another namespace and demonstrate we can use this.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Variation points:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clusters with and without Prometheus end points</p>
</li>
<li>
<p>Clusters using CBS 7.0+ and Prometheus exporter</p>
</li>
<li>
<p>Clusters with different credentials</p>
</li>
<li>
<p>Clusters using different versions of Couchbase Server</p>
</li>
<li>
<p>In same namespace and separate namespaces</p>
</li>
<li>
<p>With and without the useful extras like kube-state-metrics and eventrouter</p>
</li>
<li>
<p>CE and EE clusters (not with CAO though for EE)</p>
</li>
<li>
<p>On-prem and CAO clusters mixed together for monitoring</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We use the BATS framework (reuse some SDK set up tests as well) to verify all this locally using a docker-compose stack to represent an on-premise option and a KIND cluster for a kubernetes option.
Scale up to run tests in GKE as well using multiple nodes explicitly there.</p>
</div>
<div class="sect2">
<h3 id="_test_configuration"><a class="anchor" href="#_test_configuration"></a>Test configuration</h3>
<div class="paragraph">
<p>Testing is broken down into general <code>smoke</code> tests independent of the infrastructure we are running on, e.g. the general ones above, and <code>integration</code> tests that are cover some specific aspect for a particular infrastructure, e.g. a Kubernetes-specific test case.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_caveats_and_restrictions"><a class="anchor" href="#_caveats_and_restrictions"></a>Caveats and restrictions</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>No support for data persistence is currently provided: <a href="https://github.com/couchbaselabs/observability/issues/5" class="bare">https://github.com/couchbaselabs/observability/issues/5</a></p>
</li>
<li>
<p>Limited compatibility by supporting migrating from previous version to latest version. Best efforts will be made but the intention is this iterates often and no backwards compatibility is provided. We will show how to migrate from X-1 to X but no more than that, users should be following an agile lifecycle of constant upgrade.</p>
</li>
<li>
<p>The Couchbase cluster monitor is proprietary and requires access to the repository to build it into the container. The container can be built without it by removing it and there is a <a href="tools/build-oss-container.sh">helper script</a> that does this.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources"><a class="anchor" href="#_resources"></a>Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>A good overview of how Prometheus and Alert Manager: <a href="https://www.fabernovel.com/en/engineering/alerting-in-prometheus-or-how-i-can-sleep-well-at-night" class="bare">https://www.fabernovel.com/en/engineering/alerting-in-prometheus-or-how-i-can-sleep-well-at-night</a></p>
</li>
<li>
<p>How to disable or override rules: <a href="https://medium.com/@hauskrechtmartin/how-we-solved-our-need-to-override-prometheus-alerts-b9faf9a4558c" class="bare">https://medium.com/@hauskrechtmartin/how-we-solved-our-need-to-override-prometheus-alerts-b9faf9a4558c</a></p>
</li>
<li>
<p>Useful example rules: <a href="https://awesome-prometheus-alerts.grep.to/rules.html" class="bare">https://awesome-prometheus-alerts.grep.to/rules.html</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_feedback"><a class="anchor" href="#_feedback"></a>Feedback</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Please use our official <a href="https://issues.couchbase.com/projects/CMOS/issues">JIRA board</a> to report any bugs and issues with the appropriate components. We also encourage you to use the <a href="https://forums.couchbase.com">Couchbase Forums</a> for posting any questions or feedback that you might have.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_support"><a class="anchor" href="#_support"></a>Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>No official support is currently provided but best efforts will be made.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_release_tagging_and_branching"><a class="anchor" href="#_release_tagging_and_branching"></a>Release tagging and branching</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Every release to DockerHub will include a matching identical Git tag here, i.e. the tags on <a href="https://hub.docker.com/r/couchbase/observability-stack/tags" class="bare">https://hub.docker.com/r/couchbase/observability-stack/tags</a> will have a matching tag in this repository that built them.
Updates will be pushed to the <code>main</code> branch often and then tagged once released as a new image version.
Tags will not be moved after release, even just for a documentation update - this should trigger a new release or just be available as the latest version on <code>main</code>.</p>
</div>
<div class="paragraph">
<p>The branching strategy is to minimize any branches other than <code>main</code> following the standard <a href="https://guides.github.com/introduction/flow/">GitHub flow model</a>.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
