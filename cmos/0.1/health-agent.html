<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Couchbase Health Agent :: Couchbase Monitoring and Observability Stack</title>
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/cmos">Couchbase Monitoring and Observability Stack</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="cmos" data-version="0.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Couchbase Monitoring and Observability Stack</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Introduction</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Home</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="quickstart.html">Quick start guide</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Key Concepts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="architecture.html">Architecture overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="deployment-microlith.html">Microlith container deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cluster-monitor.html">Couchbase Cluster Monitor</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="health-agent.html">Couchbase Health Agent</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="deployment-distributed.html">Distributed microservices deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Components</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Metrics</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="component-prometheus.html">Prometheus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="component-exporter.html">Exporter</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Logging</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="component-fluent-bit.html">Fluent Bit</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="component-loki.html">Loki</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Visualization</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="component-grafana.html">Grafana</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Alerting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="component-alertmanager.html">Alertmanager</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tracing</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="component-jaeger.html">Jaeger</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="configure-cmos.html">CMOS Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="security-considerations.html">Security Considerations</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Deployment</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="deployment-onpremise.html">On-premise deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="integrating-with-existing-deployments.html">Integrating with existing monitoring pipelines</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="deployment-fluentbit.html">Fluent Bit deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-onpremise.html">On-premise example</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-kubernetes.html">Kubernetes example</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-host-level-metrics-node-exporter.html">Host-Level Metrics with the Node Exporter</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-systemd-exporter.html">Systemd Exporter</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-process-exporter.html">Process Exporter</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-pushgateway.html">Pushgateway</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Further Information</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="prerequisite-and-setup.html">Pre-requisites</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="licensing.html">Licensing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="support.html">Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="release-notes.html">Release Notes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cluster-monitor-api.html">Cluster Monitor API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="health-checks.html">Health Checks</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Couchbase Monitoring and Observability Stack</span>
    <span class="version">0.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">Couchbase Monitoring and Observability Stack</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Couchbase Monitoring and Observability Stack</a></li>
    <li>Key Concepts</li>
    <li><a href="health-agent.html">Couchbase Health Agent</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/couchbaselabs/observability/edit/main/docs/modules/ROOT/pages/health-agent.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Couchbase Health Agent</h1>
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
The Health Agent integrates several tools needed for full monitoring of Couchbase Server, including a Prometheus exporter, Fluent Bit, log analysis, and system-level health checks.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While it is possible to detect many issues in a running cluster from its metrics, logs, and deep insights provided by the <a href="cluster-monitor.html" class="page">Cluster Monitor</a>, some issues can only be detected at the system level.
This is the primary task of the Health Agent.
However, it can also assist in setting up a complete observability stack by providing additional tools, including a Prometheus exporter, pre-configured Fluent Bit, and a log analyzer directly on the node.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_get_started"><a class="anchor" href="#_get_started"></a>Get Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Download the package:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://packages.couchbase.com/couchbase-observability-stack/dp2/cbhealthagent-linux-amd64-dp2.deb" target="_blank" rel="noopener"><code>cbhealthagent-linux-amd64.deb</code></a></p>
</li>
<li>
<p><a href="https://packages.couchbase.com/couchbase-observability-stack/dp2/cbhealthagent-linux-amd64-dp2.rpm" target="_blank" rel="noopener"><code>cbhealthagent-linux-amd64.rpm</code></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This package contains <code>cbhealth-agent</code>, Fluent Bit, and the required Fluent Bit configuration for parsing Couchbase Server logs.</p>
</div>
<div class="paragraph">
<p>Install it on your server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ sudo dpkg -i cbhealthagent-linux-amd64-dp2.deb
# or
$ sudo yum install cbhealthagent-linux-amd64-dp2.rpm</code></pre>
</div>
</div>
<div class="paragraph">
<p>Start it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ sudo systemctl start cbhealthagent
$ sudo systemctl status cbhealthagent</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration"><a class="anchor" href="#_configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Health Agent is intended to be used together with the <a href="cluster-monitor.html" class="page">Cluster Monitor</a>.
It uses the same credentials as the Cluster Monitor to access the Couchbase Server node it is running on - these are exchanged the first time they communicate.</p>
</div>
<div class="paragraph">
<p>You can override this behavior and manually supply the credentials to use using the <code>--couchbase.username</code> and <code>--couchbase.password</code> command-line parameters (or <code>COUCHBASE_USERNAME</code> and <code>COUCHBASE_PASSWORD</code> environment variables).
The Agent requires at least Read-Only Admin access.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_components"><a class="anchor" href="#_components"></a>Components</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When it starts, the Agent detects the version of Couchbase Server in use by the node it is running on, and dynamically enables or disables its components based on this.
For example, the Prometheus exporter will not be enabled when the node is running Couchbase Server 7.0 or later, because Couchbase Server includes its own built-in Prometheus metrics.</p>
</div>
<div class="paragraph">
<p>This can be overridden using the <code>--features.enable</code> and <code>--features.disable</code> command-line parameters.
Both accept a comma-separated list of features to forcibly enable or disable, respectively.
The accepted values are <code>health-agent</code>, <code>fluent-bit</code>, <code>log-analyzer</code>, and <code>prometheus-exporter</code>.</p>
</div>
<div class="paragraph">
<p>The automatic feature detection can also be disabled by passing <code>--features.auto=false</code> - in this case, by default no features will be enabled unless <code>--features.enable</code> is used.</p>
</div>
<div class="sect2">
<h3 id="_system_health_checks"><a class="anchor" href="#_system_health_checks"></a>System Health Checks</h3>
<div class="paragraph">
<p>The Agent performs a number of health checks that cannot be performed in any other way, for example checking kernel parameters or whether the node can reach all the other nodes in the cluster.
A full list can be seen in the <a href="health-checks.html" class="page">Health Checks reference</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_prometheus_exporter"><a class="anchor" href="#_prometheus_exporter"></a>Prometheus Exporter</h3>
<div class="paragraph">
<p>The Agent integrates the <a href="https://github.com/couchbaselabs/cmos-prometheus-exporter" target="_blank" rel="noopener">CMOS Prometheus Exporter</a> for Couchbase Server 6.x and below nodes.
It translates the statistics from these nodes into the format that Couchbase Server 7.0 uses.</p>
</div>
<div class="paragraph">
<p>By default, the Exporter can be accessed over HTTP on port <code>9092</code> on each node, on <code>/metrics</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fluent_bit"><a class="anchor" href="#_fluent_bit"></a>Fluent Bit</h3>
<div class="paragraph">
<p>The Agent ships with <a href="https://fluentbit.io" target="_blank" rel="noopener">Fluent Bit</a> and the <a href="https://github.com/couchbase/couchbase-fluent-bit" target="_blank" rel="noopener">Couchbase Fluent Bit configuration</a>, and automatically configures it to find the Couchbase Server log files.</p>
</div>
<div class="paragraph">
<p>By default, the Agent&#8217;s bundled Fluent Bit will only ship logs to the <a href="#log_analyzer">integrated log analyzer</a>, however it can be configured to also send them to other destinations, including <a href="#loki.adoc" class="page unresolved">Loki</a>, <a href="https://docs.fluentbit.io/manual/pipeline/outputs/splunk" target="_blank" rel="noopener">Splunk</a>, <a href="https://docs.fluentbit.io/manual/pipeline/outputs/elasticsearch" target="_blank" rel="noopener">Elasticsearch</a>, and other log aggregators.
This can be done by editing its configuration file, which can be found in <code>/opt/cbhealthagent/etc/fluent-bit</code>.
Refer to the <a href="https://docs.fluentbit.io/manual/" target="_blank" rel="noopener">Fluent Bit documentation</a> for the supported syntax and parameters.</p>
</div>
</div>
<div class="sect2">
<h3 id="log_analyzer"><a class="anchor" href="#log_analyzer"></a>Log Analyzer</h3>
<div class="paragraph">
<p>In many deployments, it is undesirable to ship all of Couchbase Server&#8217;s logs to an external aggregator just to search for messages matching a certain condition.
This is the job of the Log Analyzer (also referred to as "Hazelnut") - an extension of the Agent&#8217;s built-in health checks.</p>
</div>
<div class="paragraph">
<p>It receives live logging from Fluent Bit over a local TCP connection, and searches the logging for messages indicating a potential issue with Couchbase Server.
These are then reported to a <a href="cluster-monitor.html" class="page">Cluster Monitor</a> the same way as other health check results would be.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="integrating-with-existing-deployments.html" class="page">Integrating with Existing Monitoring Pipelines</a></p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
