---
groups:
  - name: Couchbase-Server
    rules:

      - alert: CB90036-memcachedCrash
        expr: |
          count_over_time({file="memcached.log"} |= "Breakpad caught crash" | json | label_format cluster=couchbase_cluster [1h]) > 0
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: node
          severity: warning
          health_check_id: CB90036
          health_check_name: memcachedCrash
          cluster: '{{ $labels.cluster }}'
          node: '{{ $labels.hostname }}'
        annotations:
          title: Data Service Crash ({{ $labels.hostname }})
          description: The Data Service on {{ $labels.hostname }} (cluster {{ $labels.cluster }}) has crashed.
          remediation: Review memcached.log to identify the cause, or contact Couchbase Technical Support.

      - alert: CB90037-slowOperations
        expr: |
          sum(count_over_time (
          {file="memcached.log"} |= "Slow operation:" !~ `(CREATE_BUCKET|CMD_SEQNO_PERSISTENCE|CMD_COMPACT_DB)` | label_format cluster=couchbase_cluster | json message="message",hostname="hostname" | line_format "{{.message}}" | pattern "<_>Slow operation: <payload>" | line_format "{{.payload}}" | json
          [5m])) by (cluster, node, bucket) > 0
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: bucket
          severity: info
          health_check_id: CB90037
          health_check_name: slowOperations
          cluster: '{{ $labels.cluster }}'
          node: '{{ $labels.hostname }}'
          bucket: '{{ $labels.bucket }}'
        annotations:
          title: Slow KV Operations ({{ $labels.hostname }})
          description: Slow operations reported on {{ $labels.hostname }} for bucket {{$labels.bucket}}.
          remediation: Review system resource usage on {{ $labels.hostname }}.

      - alert: CB90033-longDcpNames-failedDcpOpen
        expr: |
          sum(count_over_time(
            {file="memcached.log"} |= `Invalid format specified for "DCP_OPEN"` |= `Reason:"Key length exceeds 250"` | json hostname="hostname" [5m]
          )) by (couchbase_cluster, hostname) > 0
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: cluster # even though this is technically node-level logging, the issue is cluster-level
          severity: critical
          health_check_id: CB90033
          health_check_name: longDcpNames
          cluster: '{{ $labels.couchbase_cluster }}'
        annotations:
          title: DCP Connection Failures due to MB-34280 (cluster {{ $labels.couchbase_cluster }})
          description: Node {{ $labels.hostname }} has reported failures establishing DCP connections due to long connection names (known issue MB-34280).
          remediation: Reduce the lengths of your nodes' hostnames, or contact Couchbase Technical Support.

      - alert: CB90033-longDcpNames-failedResponse
        expr: |
          sum(count_over_time(
            {file="memcached.log"} |= "Response::setKeylen: key cannot exceed 1 byte" | json hostname="hostname" [5m]
          )) by (couchbase_cluster, hostname) > 0
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: cluster # even though this is technically node-level logging, the issue is cluster-level
          severity: critical
          health_check_id: CB90033
          health_check_name: longDcpNames
          cluster: '{{ $labels.couchbase_cluster }}'
        annotations:
          title: Long DCP Names (MB-34280) (cluster {{ $labels.couchbase_cluster }})
          description: Node {{ $labels.hostname }} has reported errors due to long connection names (known issue MB-34280).
          remediation: Reduce the lengths of your nodes' hostnames, or contact Couchbase Technical Support.

      - alert: CB90044-babysitterManagedProcessCrash
        expr: |
          count_over_time({file="babysitter.log"} |~ ".*Cushion managed supervisor for.*failed:.*" | label_format cluster=couchbase_cluster | json message="message" | line_format "{{.message}}" | pattern "<_>Cushion managed supervisor for <process> failed: <reason>" [1h]) > 0
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: node
          severity: critical
          health_check_id: CB90044
          health_check_name: babysitterManagedProcessCrash
          cluster: '{{ $labels.cluster }}'
          node: '{{ $labels.hostname }}'
          process: '{{ $labels.process }}'
          reason: '{{$labels.reason}}'
        annotations:
          title: Process managed by babysitter has crashed ({{ $labels.hostname }})
          description: "The following proccess managed by Couchbase Server's babysitter has crashed with the message: {{ $labels.process }} - {{$labels.reason}}"
          remediation: Contact Couchbase Technical Support.

      - alert: CB90046-indexerCrash
        expr: |
          count_over_time({file="indexer.log"} |~ ".*(panic:|fatal error:).*" | json | label_format cluster=couchbase_cluster [1h]) > 0
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: node
          severity: critical
          health_check_id: CB90046
          health_check_name: indexerCrash
          cluster: '{{ $labels.cluster }}'
          node: '{{ $labels.hostname }}'
        annotations:
          title: Index Service Crash ({{ $labels.hostname }})
          description: The Index Service on {{ $labels.hostname }} (cluster {{ $labels.cluster }}) has crashed.
          remediation: Review indexer.log to identify the cause, or contact Couchbase Technical Support.

# CB90047-queryCrash, currently couchbase-fluent-bit does not work with query.log

      - alert: CB90048-goxdcrCrash
        expr: |
          count_over_time({file="goxdcr.log"} |~ ".*panic.*" | json | label_format cluster=couchbase_cluster [1h]) > 0
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: node
          severity: critical
          health_check_id: CB90048
          health_check_name: goxdcrCrash
          cluster: '{{ $labels.cluster }}'
          node: '{{ $labels.hostname }}'
        annotations:
          title: XDCR Crash ({{ $labels.hostname }})
          description: XDCR on {{ $labels.hostname }} (cluster {{ $labels.cluster }}) has crashed.
          remediation: Review goxdcr.log to identify the cause, or contact Couchbase Technical Support.

      - alert: CB90049-ftsCrash
        expr: |
          count_over_time({file="fts.log"} |~ ".*(panic:|fatal error|fatal, err).*" | json | label_format cluster=couchbase_cluster [1h]) > 0
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: node
          severity: critical
          health_check_id: CB90049
          health_check_name: ftsCrash
          cluster: '{{ $labels.cluster }}'
          node: '{{ $labels.hostname }}'
        annotations:
          title: Full Text Search Crash ({{ $labels.hostname }})
          description: FTS on {{ $labels.hostname }} (cluster {{ $labels.cluster }}) has crashed.
          remediation: Review fts.log to identify the cause, or contact Couchbase Technical Support.

      - alert: CB90050-eventingCrash
        expr: |
          count_over_time({file="eventing.log"} |~ ".*(panic:|fatal error:).*" | json | label_format cluster=couchbase_cluster [1h]) > 0
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: node
          severity: critical
          health_check_id: CB90050
          health_check_name: eventingCrash
          cluster: '{{ $labels.cluster }}'
          node: '{{ $labels.hostname }}'
        annotations:
          title: Eventing Crash ({{ $labels.hostname }})
          description: Eventing on {{ $labels.hostname }} (cluster {{ $labels.cluster }}) has crashed.
          remediation: Review eventing.log to identify the cause, or contact Couchbase Technical Support.

      - alert: CB90051-analyticsCrash
        expr: |
          count_over_time({file="analytics_debug.log"} |~ ".*JVM halting.*" | json | label_format cluster=couchbase_cluster [1h]) > 0
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: node
          severity: critical
          health_check_id: CB90050
          health_check_name: analyticsCrash
          cluster: '{{ $labels.cluster }}'
          node: '{{ $labels.hostname }}'
        annotations:
          title: Analytics Crash ({{ $labels.hostname }})
          description: Analytics on {{ $labels.hostname }} (cluster {{ $labels.cluster }}) has crashed.
          remediation: Review analytics_debug.log to identify the cause, or contact Couchbase Technical Support.
