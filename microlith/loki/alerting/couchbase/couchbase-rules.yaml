---
groups:
  - name: Couchbase-Server
    rules:

      - alert: CB90036-memcachedCrash
        expr: |
          count_over_time({file="memcached.log"} |= "Breakpad caught crash" | json | label_format cluster=couchbase_cluster,node=hostname [1h])
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: node
          severity: warning
          health_check_id: CB90036
          health_check_name: memcachedCrash
          cluster: '{{ $labels.cluster }}'
          node: '{{ $labels.node }}'
        annotations:
          title: Data Service Crash ({{ $labels.node }})
          description: The Data Service on {{ $labels.node }} (cluster {{ $labels.cluster }}) has crashed.
          remediation: Review memcached.log to identify the cause, or contact Couchbase Technical Support.

      - alert: CB90037-slowOperations
        expr: |
          sum(count_over_time (
          {file="memcached.log"} |= "Slow operation:" !~ `(CREATE_BUCKET|CMD_SEQNO_PERSISTENCE|CMD_COMPACT_DB)` | label_format cluster=couchbase_cluster | json message="message",node="hostname" | line_format "{{.message}}" | pattern "<_>Slow operation: <payload>" | line_format "{{.payload}}" | json
          [5m])) by (cluster, node, bucket) > 0
        for: 1m
        labels:
          job: couchbase_fluent_bit
          kind: bucket
          severity: info
          health_check_id: CB90037
          health_check_name: slowOperations
          cluster: '{{ $labels.cluster }}'
          node: '{{ $labels.node }}'
          bucket: '{{ $labels.bucket }}'
        annotations:
          title: Slow KV Operations ({{ $labels.node }})
          description: Slow operations reported on {{ $labels.node }} for bucket {{$labels.bucket}}.
          remediation: Review system resource usage on {{ $labels.node }}.
