<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Add Cluster | CMOS</title>
  </head>
  <body>
    <h1>Configuration</h1>
    <div x-data="generator">
      <form name="inputForm" id="inputForm">
        <fieldset>
          <div>
            <label for="serverHost">Couchbase Server Hostname:</label>
            <input
                    type="text"
                    id="serverHost"
                    x-model="hostname"
                    placeholder=""
                    required
            />
          </div>
          <div>
            <label for="serverUser">Couchbase Server Username:</label>
            <input
              type="text"
              id="serverUser"
              x-model="serverUsername"
              placeholder="Administrator"
              required
            />
          </div>
          <div>
            <label for="serverPwd">Couchbase Server Password:</label>
            <input
              type="password"
              id="serverPwd"
              x-model="serverPassword"
              placeholder="password"
              required
            />
          </div>
          <div>
            <label for="managementPort"
              >Couchbase Server Management Port:</label
            >
            <input
              type="text"
              id="managementPort"
              x-model="managementPort"
              required
            />
          </div>
          <div>
            <label>
              <input type="checkbox" x-model="useTLS" />
              <strong>Use TLS?</strong>
            </label>
          </div>
        </fieldset>
        <fieldset>
          <legend>
            <h2>Couchbase Cluster Monitor configuration</h2>
          </legend>
          <div>
            <div>
              <label for="cbmmUsername"
                >Couchbase Cluster Monitor username:</label
              >
              <input
                type="text"
                id="cbmmUsername"
                x-model="cbmmUsername"
                required
              />
            </div>
            <div>
              <label for="cbmmPassword"
                >Couchbase Cluster Monitor password:</label
              >
              <input
                type="password"
                id="cbmmPassword"
                x-model="cbmmPassword"
                required
              />
            </div>
          </div>
        </fieldset>
        <div>
          <button type="submit" @click.prevent="configure()">
            Add Cluster
          </button>
          <button type="submit" @click.prevent="generate()">
            Show Configuration
          </button>
        </div>
      </form>
      <div x-show="jsonPrometheus.length > 0 && doPrometheus">
        <h2>Prometheus configuration</h2>
        <p>
          Save the below JSON to a file and place it in
          <code>/etc/prometheus/couchbase/custom/cluster-name.json</code>. For example:
          <code>docker cp cluster-name.json cmos:/etc/prometheus/couchbase/custom/cluster-name.json</code>
          (substitute <code>cmos</code> for the name of your running container).
          Once saved, check the "Targets" page in Prometheus to see if it has
          picked it up. If it does not, wait 30-60 seconds and check again, as
          the process is not instant.
        </p>
        <pre id="jsonPrometheus" x-text="jsonPrometheus"></pre>
      </div>
      <div x-show="healthcheckCommand.length > 0">
        <h2>Couchbase Healthcheck configuration</h2>
        <p>
          Execute this command to register a Couchbase Server cluster with the
          local Cluster Monitor process.
        </p>
        <textarea
          x-text="healthcheckCommand"
          id="healthcheckCommand"
          class="generatedCode"
          onclick="this.focus();this.select()"
          cols="80"
          rows="4"
          readonly
        ></textarea>
      </div>
      <div x-show="loading">Loading, please wait&hellip;</div>
      <div x-show="success">
        Cluster successfully added! Go to
        <a href="/grafana/?orgId=1">Grafana</a> to see its health. Please note
        that it may take up to 60 seconds for all data to be available.
      </div>
      <div x-show="error.length > 0" x-text="error"></div>
    </div>
    <script defer src="/alpine-3.4.2.min.js"></script>
    <script>
      document.addEventListener("alpine:init", function () {
        Alpine.data("generator", function () {
          return {
            managementPort: "8091",
            useTLS: false,
            hostname: "",
            serverUsername: "",
            serverPassword: "",

            cbmmUsername: "admin",
            cbmmPassword: "password",

            jsonPrometheus: "",
            healthcheckCommand: "",

            success: false,
            error: "",
            loading: false,

            init() {
              this.$watch('secure', () => {
                if (this.managementPort === '8091' && this.useTLS) {
                  this.managementPort = '18091';
                } else if (this.managementPort === '18091' && !this.useTLS) {
                  this.managementPort = '8091';
                }
              })
            },

            generate() {
              this.jsonPrometheus = JSON.stringify(
                [
                  {
                    targets: [this.hostname + ":8091"],
                    labels: {},
                  },
                ],
                null,
                2
              );
              const serverConfig = JSON.stringify({
                user: this.serverUsername,
                password: this.serverPassword,
                host: this.hostname + ":" + this.managementPort,
              });
              this.healthcheckCommand = `curl -u ${this.cbmmUsername}:${this.cbmmPassword} -X POST -d '${serverConfig}' 'http://localhost/api/v1/clusters'`;
            },

            async configure() {
              this.error = "";
              this.success = false;
              this.loading = true;
              try {
                await fetch("/config/api/v1/clusters/add", {
                  method: "post",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    hostname: this.hostname,
                    couchbaseConfig: {
                      username: this.serverUsername,
                      password: this.serverPassword,
                      managementPort: parseInt(this.managementPort, 10),
                      secure: this.secure,
                    },
                  }),
                })
                  .then(async (resp) => {
                    if (resp.status !== 200) {
                      const data = await resp.json();
                      throw new Error(
                        `received unexpected status ${resp.status}: ${
                          "err" in data ? data.err : JSON.stringify(data)
                        }`
                      );
                    }
                  })
                  .catch((e) =>
                    Promise.reject(
                      `Failed to add node to Prometheus: ${String(e)}`
                    )
                  );

                await fetch("/couchbase/api/v1/clusters", {
                  method: "post",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization:
                      "Basic " +
                      btoa(`${this.cbmmUsername}:${this.cbmmPassword}`),
                  },
                  body: JSON.stringify({
                    user: this.serverUsername,
                    password: this.serverPassword,
                    host: this.hostname + ":" + this.managementPort,
                  }),
                })
                  .then(async (resp) => {
                    if (resp.status !== 200) {
                      switch (resp.headers.get("Content-Type")) {
                        case "application/json":
                          const data = await resp.json();
                          if ("extras" in data) {
                            throw new Error(
                              `received unexpected status ${resp.status} with extras: ${data.extras}`
                            );
                          } else if ("msg" in data) {
                            throw new Error(
                              `received unexpected status ${resp.status} with msg: ${data.msg}`
                            );
                          } else {
                            throw new Error(
                              `received unexpected status ${resp.status} with data: ` +
                                JSON.stringify(data)
                            );
                          }
                        default:
                          throw new Error(
                            `received unexpected status ${resp.status}: ` +
                              (await resp.text())
                          );
                      }
                    }
                  })
                  .catch((e) =>
                    Promise.reject(
                      `Failed to register node with Cluster Monitor: ${String(
                        e
                      )}`
                    )
                  );

                await fetch("/prometheus/-/reload", { method: "post" })
                  .then((resp) => {
                    if (resp.status !== 200) {
                      return Promise.reject(
                        `Failed to reload Prometheus: ${String(
                          e
                        )} (note that the cluster was successfully added)`
                      );
                    }
                  })
                  .catch((e) =>
                    Promise.reject(
                      `Failed to reload Prometheus: ${String(
                        e
                      )} (note that the cluster was successfully added)`
                    )
                  );

                this.success = true;
                this.loading = false;
              } catch (e) {
                this.loading = false;
                this.error = String(e);
              }
            },
          };
        });
      });
    </script>
  </body>
</html>
