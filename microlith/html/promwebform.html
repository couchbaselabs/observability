<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Add Cluster | CMOS</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body class="doc">
    <header class="header fixed-top">
      <div class="header-top-row">
        <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
            <ul class="navbar-brand-list">
              <li class="brand-logo">
                <a class="navbar-brand" href="https://www.couchbase.com">
                  <img src="img/couchbase-logo.svg" alt="Couchbase">
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </header>
    <main class="container">
      <h1>Configuration</h1>
      <p>This form runs on the CMOS container so enter valid hostnames or addresses that are resolvable from it.
        Do not enter localhost or 127.0.0.1 for example as that will resolve to the CMOS container itself.</p>
      <div x-data="generator">
        <form name="inputForm" id="inputForm">
          <fieldset>
            <div>
              <label for="alias">Couchbase Server Alias:</label>
              <input type="text" id="alias" x-model="alias" placeholder="" pattern="^\s*[^\S]+\s*$" required />
            </div>
            <div>
              <label for="serverHost">Couchbase Server Hostname:</label>
              <input type="text" id="serverHost" x-model="hostname" placeholder="" pattern="^\s*[^\S]+\s*$" required />
            </div>
            <div>
              <label for="serverUser">Couchbase Server Username:</label>
              <input type="text" id="serverUser" x-model="serverUsername" placeholder="Administrator" required />
            </div>
            <div>
              <label for="serverPwd">Couchbase Server Password:</label>
              <input type="password" id="serverPwd" x-model="serverPassword" placeholder="password" required />
            </div>
            <div>
              <label for="managementPort">Couchbase Server Management Port:</label>
              <input type="text" id="managementPort" x-model="managementPort" required />
            </div>
            <div>
              <label>
                <input type="checkbox" x-model="useTLS" />
                <strong>Use TLS?</strong>
              </label>
            </div>
          </fieldset>
          <fieldset>
            <div>
              <label>
                <input type="checkbox" x-model="doSGW" />
                Add Sync Gateway Instance?
            </label>
          </div>
          <div>
            <label>
              <input type="checkbox" x-model="doProm" />
              Add to Prometheus?
            </label>
          </div>
          <div>
            <label>
              <input type="checkbox" x-model="doCBMM" />
              Add to Couchbase Cluster Monitor?
            </label>
          </div>
        </fieldset>
        <fieldset x-show="doSGW">
          <legend>
            <h2>Sync Gateway configuration</h2>
          </legend>
          <div>
            <label for="sgwHost">Sync Gateway Hostname:</label>
            <input type="text" id="sgwHost" x-model="sgwHostname" placeholder="" pattern="^\s*[^\S]+\s*$" required />
          </div>
          <div>
            <label for="sgwUser">Sync Gateway API Admin Username:</label>
            <input type="text" id="sgwUser" x-model="sgwUsername" placeholder="api-admin" required />
          </div>
          <div>
            <label for="sgwPwd">Sync Gateway API Admin Password:</label>
            <input type="password" id="sgwPwd" x-model="sgwPassword" placeholder="password" required />
          </div>
        </fieldset>
        <fieldset x-show="doProm">
          <legend>
            <h2>Prometheus configuration</h2>
          </legend>
          <div>
            <label for="prometheusPort">Prometheus Exporter Port:</label>
            <input type="text" id="prometheusPort" x-model="prometheusPort" required />
            <br />
            <em>Note: this field is not necessary (and will be ignored) if the cluster is running Couchbase Server 7.0 or above, as the built-in Prometheus metrics will be used and an exporter is not necessary.</em>
          </div>
        </fieldset>
        <fieldset x-show="doCBMM">
          <legend>
            <h2>Couchbase Cluster Monitor configuration</h2>
          </legend>
          <div>
            <div>
              <label for="cbmmUsername">Couchbase Cluster Monitor username:</label>
              <input type="text" id="cbmmUsername" x-model="cbmmUsername" required />
            </div>
            <div>
              <label for="cbmmPassword">Couchbase Cluster Monitor password:</label>
              <input type="password" id="cbmmPassword" x-model="cbmmPassword" required />
            </div>
          </div>
        </fieldset>
        <div>
          <button type="submit" class="btn btn-primary" @click.prevent="configureAndStore(getConfig())" :disabled="!(doProm || doCBMM)">
            Add Cluster
          </button>
          <button type="button" class="btn btn-grey-reverse" @click.prevent="generate()" :disabled="!(doProm || doCBMM)">
            Show Manual Configuration Steps
          </button>
        </div>
      </form>

      <div x-show="yamlPrometheus.length > 0 && doProm">
        <h2>Prometheus configuration</h2>
        <p>
          Add the following fragment of YAML to <code>/etc/prometheus/prometheus.runtime.yml</code>, in the
          <code>scrape_configs</code> section. Make sure to replace <code>&lt;cluster name&gt;</code> with the name of
          the cluster (as reported in the Couchbase Web Console). Once saved, check the "Targets" page in Prometheus to see if it has picked it up. If it does not, wait 30-60 seconds and check again, as the process is not instant.
        </p>
        <pre id="jsonPrometheus" x-text="yamlPrometheus"></pre>
      </div>
      <div x-show="healthcheckCommand.length > 0 && doCBMM">
        <h2>Couchbase Healthcheck configuration</h2>
        <p>Execute this command to register a Couchbase Server cluster with the local Cluster Monitor process.</p>
        <textarea x-text="healthcheckCommand" id="healthcheckCommand" class="generatedCode" onclick="this.focus();this.select()" cols="80" rows="4" readonly></textarea>
      </div>
      <div x-show="loading">Loading, please wait&hellip;</div>
      <div x-show="success">
        Cluster successfully added! Go to
        <a href="grafana/?orgId=1">Grafana</a> to see its health. Please note that it may take up to 60 seconds for all data to be available.
      </div>
      <div x-show="error.length > 0" x-text="error" style="color: red; font-weight: bold;"></div>
    </div>
  </main>
  <footer style="margin: 2em;">
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>Â© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
      </div>
    </div>
  </footer>
  <script defer src="alpine-3.4.2.min.js"></script>
  <script>
    document.addEventListener("alpine:init", function () {
      Alpine.data("generator", function () {
        return {
          managementPort: "8091",
          useTLS: false,
          hostname: "",
          alias: "",
          serverUsername: "",
          serverPassword: "",
          sgwHostname: "",
          sgwUsername: "",
          sgwPassword: "",

          cbmmUsername: "admin",
          cbmmPassword: "password",

          prometheusPort: 9091,
          sgwPrometheusPort: 4986,

          yamlPrometheus: "",
          healthcheckCommand: "",

          doSGW: true,
          doProm: true,
          doCBMM: true,

          success: false,
          error: "",
          loading: false,
 
          validate() {
            if (this.alias.trim().length === 0) {
              this.error = "Alias missing";
              return false;
            }
            if (this.hostname.trim().length === 0) {
              this.error = "Hostname invalid";
              return false;
            }
            if (this.serverUsername.length === 0 || this.serverPassword.length === 0) {
              this.error = "Server username or password missing";
              return false;
            }
            if (this.doCBMM) {
              if (this.cbmmUsername.length === 0 || this.cbmmPassword.length === 0) {
                this.error = "Couchbase Cluster Monitor username or password missing";
                return false;
              }
            }
            return true;
          },

          init() { 
             this.pathPrefix = `http://${window.location.hostname}:8080`; // Adjust this according to your server setup

            
            this.$watch("useTLS", () => {
              if (this.managementPort === "8091" && this.useTLS) {
                this.managementPort = "18091";
              } else if (this.managementPort === "18091" && !this.useTLS) {
                this.managementPort = "8091";
              }
            });
          },

          generate() {
            this.error = "";
            this.success = false;
            if (!this.validate()) {
              return;
            }
            if (this.doProm) {
              this.yamlPrometheus = `    - job_name: couchbase-server-<cluster name>
    static_config:
      targets:
        - '${this.hostname}:${this.prometheusPort ?? this.managementPort}'
        # Add the other nodes in the cluster here
      labels:
        cluster: <cluster name>
    basic_auth:
      username: '${this.serverUsername}'
      password: '${this.serverPassword}'`
            } else {
              this.yamlPrometheus = "";
            }
            if (this.doCBMM) {
              const serverConfig = JSON.stringify({
                user: this.serverUsername,
                password: this.serverPassword,
                host: this.hostname.trim() + ":" + this.managementPort.trim(),
              });
              this.healthcheckCommand = `curl -u ${this.cbmmUsername}:${this.cbmmPassword} -X POST -d '${serverConfig}' 'http://localhost/api/v1/clusters'`;
            } else {
              this.healthcheckCommand = "";
            }
          },

         getConfig(){
         const config = {
                             hostname: this.hostname,
                             alias: this.alias,
                             serverUsername: this.serverUsername,
                             serverPassword: this.serverPassword,
                             managementPort: this.managementPort,
                             useTLS: this.useTLS,
                             sgwHostname: this.sgwHostname,
                             sgwUsername: this.sgwUsername,
                             sgwPassword: this.sgwPassword,
                             cbmmUsername: this.cbmmUsername,
                             cbmmPassword: this.cbmmPassword,
                             prometheusPort: this.prometheusPort,
                             sgwPrometheusPort: this.sgwPrometheusPort,
                             doSGW: this.doSGW,
                             doProm: this.doProm,
                             doCBMM: this.doCBMM,
                           };
          return config;

       },

         async configureAndStore(config) {
                           this.error = "";
                           this.success = false;
                           
                           if (!this.validate()) {
                             return;
                           }


                           await fetch(this.pathPrefix+'/persistency/api/configureCluster', {
                             method: 'POST',
                             headers: {
                               'Content-Type': 'application/json'
                             },
                             body: JSON.stringify(config)
                           })
                           .then(response => response.text())
                           .then(data => {
                             console.log(data);
                             this.success = true;
                           })
                           .catch(error => {
                             console.error('Error:', error);
                             this.error = error;
                           });

                              this.saveConfig(config);

                     }
                          ,

          saveConfig(config) {

            fetch(this.pathPrefix+'/persistency/api/saveConfig', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(config)
            })
            .then(response => response.text())
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
          }
        };
      });
    });
  </script>
</body>
</html>
