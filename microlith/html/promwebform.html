<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Generate Prometheus Endpoint Configuration</title>
  </head>
  <body>
    <h1>Configuration</h1>
    <div x-data="generator">
      <form name="inputForm" id="inputForm">
        <div>
          <label for="endpoint">Cluster label:</label>
          <input type="text" x-model="clusterLabel" required pattern="[a-zA-Z_][a-zA-Z0-9_]*" title="Permitted: ASCII letters, numbers, underscores." />
          <em>Permitted: ASCII letters, numbers, underscores.</em>
        </div>
        <h2>Couchbase Server nodes</h2>
        <template x-for="(_, index) in nodes">
          <fieldset>
            <label :for="'node' + index">Hostname / IP Address:</label>
            <input
              :id="'node' + index"
              x-model="nodes[index]"
              placeholder="127.0.0.1"
              required
            />
            <button type="button" @click="nodes.splice(index, 1)">
              Remove
            </button>
          </fieldset>
        </template>
        <div>
          <button type="button" @click="nodes.push('')">Add Node</button>
        </div>
        <fieldset>
          <legend>
            <h2>Prometheus endpoint configuration</h2>
          </legend>
          <div>
            <label for="endpoint">Prometheus Exporter port:</label>
            <input type="text" x-model="exporterPort" required />
          </div>
        </fieldset>
        <fieldset>
          <legend>
            <h2>Couchbase Healthchecker configuration</h2>
          </legend>
          <div>
            <div>
              <label for="serverUser">Couchbase Server Username:</label>
              <input
                type="text"
                id="serverUser"
                x-model="serverUsername"
                placeholder="Administrator"
                required
              />
            </div>
            <div>
              <label for="serverPwd">Couchbase Server Password:</label>
              <input
                type="password"
                id="serverPwd"
                x-model="serverPassword"
                placeholder="password"
                required
              />
            </div>
            <div>
              <label for="serverUrl">Couchbase Server Management Port:</label>
              <input
                type="text"
                id="serverUrl"
                x-model="managementPort"
                required
              />
            </div>
            <hr />
            <div>
              <label for="serverUrl">Couchbase Cluster Monitor host:</label>
              <input type="text" id="serverUrl" x-model="cbmmHost" required />
            </div>
            <div>
              <label for="serverUrl">Couchbase Cluster Monitor username:</label>
              <input
                type="text"
                id="serverUrl"
                x-model="cbmmUsername"
                required
              />
            </div>
            <div>
              <label for="serverUrl">Couchbase Cluster Monitor password:</label>
              <input
                type="password"
                id="serverUrl"
                x-model="cbmmPassword"
                required
              />
            </div>
          </div>
        </fieldset>
        <div>
          <button type="submit" @click.prevent="generate()">Generate</button>
        </div>
      </form>
      <h2>Prometheus configuration</h2>
      <div>
        <p x-show="jsonPrometheus.length > 0">
          Save the below JSON to a file and place it in <code>/etc/prometheus/couchbase/custom/<span x-text="clusterLabel"></span>.json</code>.
          For example: <code>docker cp <span x-text="clusterLabel"></span>.json cmos:/etc/prometheus/couchbase/custom/<span x-text="clusterLabel"></span>.json</code> (substitute <code>cmos</code> for the name of your running container).
          Once saved, check the "Targets" page in Prometheus to see if it has picked it up. If it does not, wait 30-60 seconds and check again, as the process is not instant.
        </p>
        <pre id="jsonPrometheus" x-text="jsonPrometheus"></pre>
      </div>
      <h2>Couchbase Healthcheck configuration</h2>
      <div>
        <p x-show="healthcheckCommand.length > 0">
          Execute this command to register a Couchbase Server cluster with the
          local Cluster Monitor process.
        </p>
        <textarea
          x-text="healthcheckCommand"
          id="healthcheckCommand"
          class="generatedCode"
          onclick="this.focus();this.select()"
          cols="80"
          rows="4"
          readonly
        ></textarea>
      </div>
    </div>
    <script defer src="/alpine-3.4.2.min.js"></script>
    <script>
      document.addEventListener("alpine:init", function () {
        Alpine.data("generator", function () {
          return {
            clusterLabel: "",
            nodes: [""],
            exporterPort: "9091",
            managementPort: "8091",
            serverUsername: "Administrator",
            serverPassword: "password",

            cbmmUsername: "admin",
            cbmmPassword: "password",
            cbmmHost: "localhost:8080/couchbase",

            jsonPrometheus: "",
            healthcheckCommand: "",

            generate() {
              this.jsonPrometheus = JSON.stringify(
                [{
                  targets: this.nodes.map(
                    (node) => `${node}:${this.exporterPort}`
                  ),
                  labels: {
                    cluster: this.clusterLabel,
                  },
                }],
                null,
                2
              );
              const serverConfig = JSON.stringify({
                user: this.serverUsername,
                password: this.serverPassword,
                host: this.nodes[0] + ":" + this.managementPort,
              });
              this.healthcheckCommand = `curl -u ${this.cbmmUsername}:${this.cbmmPassword} -X POST -d '${serverConfig}' 'http://${this.cbmmHost}/api/v1/clusters'`;
            },
          };
        });
      });
    </script>
  </body>
</html>
